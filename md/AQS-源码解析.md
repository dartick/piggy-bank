# AQS 源码

## acquire()方法

1.  尝试获取资源, 成功获取锁成功, 否则执行2.
2.  把当前线程封装成节点挂到队尾
3.  自旋获取锁

```
在队列里面获取到锁的条件是, 前驱节点为head(保证了队列上的公平性), 且竞争到资源的情况下, 才可获取到锁.
```

## release()方法

1.  尝试释放资源, 失败则返回false, 否则执行2
2.  判断head是否不为空且head.waitStatus != 0, 是则说明可能有后继节点需要唤醒, 执行3, 否则返回true

```
head.waitStatus != 0 为什么?

因为当有队列里还有其他节点, 那么必然head.waitStatus != 0, 所以需要当前线程去执行唤醒操作或者是剔除cannel节点
```

```
若当前线程A此处head若刚判断为空, 这时其他线程B把head实例化了, 那线程A不是唤醒不了线程B吗?

不会的, 线程B实例化head后还会去竞争一次资源才会挂起的.
```

3.  设置node的状态为0

4.  若存在后继节点则唤醒后继节点

5.  否则从尾部开始遍历, 距离head非cannel节点并唤醒

```
为什么从尾部遍历呢?

因为next刚好置null, 获取后继节点已取消
```

## Condition

### 作用

Condition就是条件, 它的一个作用就是线程需要等待某个条件才能继续运行下去, 所以会把自己挂起, 当条件达成后则会唤醒自己继续运行.

### await

1.  条件等待队列入队
2.  释放锁
3.  挂起
4.  尝试获取锁

### singal

1.  将条件等待队列中第一个节点入队AQS等待队列
2.  如果前驱节点取消了或者尝试设置sinal失败了, 则唤醒其线程让其自己来设置

## 同步器

研究同步器, 还是从其功能点来切入, 看它如何利用AQS来进行实现这些功能的,
然后思考其对state资源的一个定义, 怎么来维护

### ReentrantLock

#### 排他性

ReentrantLock首先是一个排他锁, 在这点上直接利用AQS的独占模式便可.

#### 公平和非公平

ReentrantLock 可以采用公平机制和非公平机制, 而公平和非公平可以从这点上来考虑, 当有线程已经在等待锁了, 那么新的线程来获取锁, 是否可以竞争到, 这点便可判断是否公平, 而在AQS上, 预留**tryAcquire**方法, 可通过这个实现. 

如果是自己来实现的话, 那么可以想象得到, 公平的一个实现就是, 首先判断是否有线程在等待, 没有才去竞争锁, 而在AQS提供了**hasQueuedPredecessors()**和**compareAndSetState()**便可满足这个实现

非公平的实现更简单了, 直接竞争资源便可.

#### 可重入性

ReentrantLock是通过state来对重入次数进行计数的, 那如果判断其是否重入, AQS提供了**getExclusiveOwnerThread()**方法来判断

#### state资源的定义

1.  0: 代表锁未被占有
2.  大于0: 说明锁已经被占用了, 且代表了重入次数

### CountDownLatch

这个类有什么用呢, 简单来说, 它可以实现一个计数器的功能, 需要等待计数器计完事后才可以做后面的事. 那么完成这个功能, 则需要实现**计数完成前的等待**, **计数**, 同时, 可以多个线程等待这个计数结果, 可以判断其需要使用共享模式完成

#### 计数

很简单, 利用state来计数, 完成一次计数则减一, 重写**tryReleaseShared()**, 对state进行原子性更新

#### 等待计数完成

也很简单, 判断该state是否为0便可, 没有计数完成, 则挂起, 那挂起后, 谁唤醒呢? 由计数线程. 判断state等于0便返回false, 否则返回true

```
这里有一点得注意, tryReleaseShared()返回false才会唤醒排队的线程
```

#### state资源的定义

1.  0: 计数完成
2.  大于0: 剩余未完成计数

#### Semaphore

信号量, 可以控制多个线程进入同步块. 从其功能上来看, 跟ReentrantLock类似, 不同的是进入同步块的线程可以有多个, 何不妨在ReentrantLock基础上考虑它的实现, 其实很简单, 就是共享模式下的ReentrantLock. 

```
注意, Semaphore是不可以重入的

semaphore.acquire()
semaphore.acquire()
semaphore.release()
```

#### CyclicBarrier




