# 分布式共识算法

## 一致性与共识

分布式一致性算法与共识算法都是解决一致性问题，但是要求不一样，一致性算法要求的是强一致性，而共识算法要求大多数认可便行，然后逐步达成一致。目前业界上分布式共识算法有很多种，常见的便是Paxos，Raft，ZAB等等，其中Paxos又分Basic-Paxos, Mutil-Paxos，而Basic-Paxos因为难以实现，所以基本只用于理论

## 基本实现原理

原理其实很简单，写的时候，跟2pc类似，都有投票和提交两个阶段，与2pc不一样的地方是，不需要所有节点响应，那么便可大大降低2pc的同步阻塞范围；而读的时候，只要大多数节点返回的值一致，那么就算读成功。当然，实际实现不会这么简单，这里还需要处理各种细节的问题。比如，写选择，投票轮次，活性保证等问题。

### 写选择

当只有一个节点发起写请求时，是没有问题的，当多个节点并发地发起请求，那么便需要解决选择的问题，解决的办法很简单，给写附带一个权重，谁的权重大则选谁

## Basic-Paxos

### 角色

1. proposal：提议者
2. acceptor：接受者
3. learner：学习者

### 基本原理

每个节点相互交换提议信息，最后达成数据的一致（最终的数据为以提议编号最大者的数据）

### 缺点

1. 难以理解，难以实现
2. 无法保证活性

## Mutil-Paxos

在Basic-Paxos加以改进，解决活锁问题

### 基本原理

选举leader，保证写操作通过leader来发起，从而避免了活锁的问题

![img](https://pic2.zhimg.com/80/v2-a1ce168e0aaea066be3d0a0764f624a9_hd.png)

### 缺点

1. 无法负载均衡写；
2. 但是可能会因为网络问题，导致多个leader被选出来，那么，算法便会退化成Basic-Paxos。

## Fast-Paxos

Fast-Paxos是基于Mutil-Paxos加以改进，该算法认为在**阶段二的提交**中，proposer -> leader -> acceptor -> learner ，从提议到完成决议的过程中，此时的提议包含了value，并且需要经过leader才提交到acceptor，Fast-Paxos认为该步骤可以去掉，减少通讯次数。

### 基本原理

从图中可以看到，leader通过发送any消息来初始化决议进程，而当决议发生冲突时，才重新参与进来，解决冲突。

![img](https://pic2.zhimg.com/80/v2-2b7eba6a4c8df06d9906b521f331801d_hd.png)

## Raft

Raft针对Paxos的难以理解和难以实现提出的，将问题拆解成四个子问题：领导选举，日志复制，安全，成员变动。此处总结下领导选举的原理

### 角色

1. candidate: 候选人
2. follower：跟随者
3. leader：领导者

### 基本原理

通过两个超时时间来控制领导选举：

1. 选举时间（120ms-300ms内的随机时间）。在选举时间内，如果未收到领导者的**心跳RPC**，那么该跟随者则会升级为候选人，向剩余的跟随者广播**选举RPC**。通过**日志索引**以及**任期**作为票选依据
2. 心跳时间。领导者心跳发送时间。

### 缺点

1. 单点读写问题。Raft规定所有的读写请求都通过leader进行操作

## ZAB

### 角色

1. leader。领导者，负责处理所有写请求，可处理读请求
2. follower。跟随者，写请求转发给leader，可处理读请求
3. observer。写请求转发给leader，可处理读请求，但不参与投票

### 基本原理

1. 通过**消息广播模式**来处理所有的读写请求
2. 通过**奔溃恢复模式**来完成leader奔溃后的选举

## 引用

1. [分布式理论(五) - 一致性算法Paxos](https://juejin.im/post/5b2664bd51882574874d8a76)
2. [实例详解ZooKeeper ZAB协议、分布式锁与领导选举](https://dbaplus.cn/news-141-1875-1.html)
3. [Zab算法与Paxos算法异同](https://anguslean.cn/2019/08/06/DistributeSystem/Zab算法与Paxos算法/)
4. [聊聊zookeeper的ZAB算法](https://juejin.im/entry/5b84d589e51d453885032159)