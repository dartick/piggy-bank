## Sql优化收集

### limit 深度分页优化

原语句：

select * from user limit 10000, 5 

优化语句：

select * from user where id >= 10000 limit 5 

利用id来过滤掉数据，但场景非常有限，即无查询条件的时候

select * from user where id in (select id from user limit 10000, 5)  

利用覆盖索引，从而减少回表的开销，当 子查询数据量大的时候，也会造成开销

select a.* from user a inner join (select b.id from user b limit 10000, 5) on a.id = b.id

### 批量插入

```sql
 INSERT INTO VALUES()
```

## sql优化总结

优化大体上可以分以下几点：

### 建表

这里的目的主要压缩表的数据，提高空间的利用率

1. 尽量字段设置Not Null。 (**这个实际上是个误区，设置Not Null并不会带来性能的多大提升**) Null 列需要更多的存储空间：需要一个额外字节作为判断是否为 NULL 的标志位
2. 时间字段尽量采用内置时间类型。便于做时间转换和比较
3. 尽可能的使用 varchar 存储字符字段。边长字符的存储空间更小。
4. 值只有0和1使用tinyint(1)。
5. 能冗余的字段最好冗余一下。此处是为了避免连表查询。

### 建索引

1. 首先得判断要不要建索引。索引的维护也会带来一定的开销，当数据量小的时候，即使查询条件含有索引字段，但是依然走全表，所以数据量小的时候，索引压根就没有用，而且还有维护的开销。**数据量大小的判断依据是300**
2. 然后判断需要在什么字段加索引。有以下三块地方：
   * **业务唯一标识字段**。通过数据库的唯一索引来约束数据的唯一性
   * **创建时间**。通过创建时间进行加索引，有利于做**数据统计**和**冷热数据分离**（比如近一个月的数据为热数据）
   * **经常用于查询的字段**。这个就看业务场景，主要办法还是搜集一下所有的**查询频率高**的语句，根据查询条件（**where，on，group by**）对选择一些**维度高**（mysql会预计结果数据，超过全表的30%则走全表扫描），**字段存储小**的字段建立索引，索引的类型可以是唯一索引，联合索引等等。

> 联合索引建立，三星索引：
>
> * 一星。常用查询字段建立索引
> * 二星。优化排序问题，主要是**group by**, **order by**
> * 三星。利用索引覆盖来避免回表

### 查询语句

这里的基本要求就是利用索引，所以得需要注意的是，防止索引失效：

1. 符合最左前缀原则。联合索引的最左匹配和字符串索引的最左匹配
2. 使用 or。可以采用**union all**来替代
3. 对列做左值运算。将运算移到右值，同时应该**注意索引字段类型匹配**。比如条件传值为数字，而索引字段为字符串类型，那么导致左值进行隐式的转换。
4. 多个单独索引时，mysql会走其中一个索引。这时可以强制使用索引 表名后面 加 index(数据量多的索引字段)，**这里mysql进行了优化，索引下推技术，把另一个索引作为过滤条件下推给存储引擎进行过滤，从而减少了回表的数据量**
5. 选择返回字段的时候只取所需。这里可以利用**覆盖索引**，避免回表，加快查询速度

### 复杂sql的优化

这里的场景主要多表连表查询：

1. 配合查询计划，对sql进行拆解，从子查询开始优化
2. 对没有必要的表去除掉
3. 注意 in 和 exists 的替换

### 慢sql

1. 通过**慢sql日志**找出需要优化的sql
2. 通过**explain**语句来进行分析
   * type: 查看是否能用索引字段进行优化
   * extra: 查看能用利用索引进行排序，能否利用**索引下推**
3. 通过**profiling**命令查看优化效果

## 引用

1. [MySQL集锦 - IN 真会导致全表扫描吗？](https://amao12580.github.io/post/2016/07/MySQL-in-operator-must-lead-to-full-scan/)
2. [说一个在工作中遇到的mysql索引失效的问题](http://www.justdojava.com/2019/09/28/mysql-index-nouse/)
3. [MySQL索引优化案例](https://www.ezlippi.com/blog/2018/08/mysql-tips.html)
4. [MySQL 性能优化神器 Explain 使用分析](https://segmentfault.com/a/1190000008131735)